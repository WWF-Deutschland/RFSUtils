#| code-fold: true
#| code-summary: "Show the code"
#| output: false
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, readxl, here, janitor, sf, glue, lay, corrplot, purrr, e1071)
library(readxl)
library(writexl)
library(dplyr)
sharepoint_dir <- "C:\\Users\\Raquel.Capella\\WWF-Deutschland\\FB-WuM-Daten - Water & Biodiversity Stewardship\\"
git_dir <- "C:\\Users\\Raquel.Capella\\OneDrive - wwfgermany\\Documents\\GitHub\\RFSTools"
inputPath <- "C:\\run_assessments_locally\\Aldi\\RFS_bulk_upload_sites_ALDI_mastersheet_v2.xlsx"
## We use the data inserted into the Bulk Uploads Excel template provided to users.
bulk_data <- read_excel(inputPath, sheet = "Add your sites here")
check_bulkUpload_colStr <- function(df) {
# Ensure df is actually a dataframe
if (!is.data.frame(df)) {
stop("The input must be a dataframe.")
}
# Define expected columns
expected_cols <- c("Company Name","Site Name","Industry","Commodity (Optional)", "Group (Optional)","Business Importance","Latitude","Longitude","Address","...10","O4a","O25a")
# Identify missing and extra columns
missing_cols <- setdiff(expected_cols, names(df))
extra_cols   <- setdiff(names(df), expected_cols)
# Warnings
if (length(missing_cols) > 0) {
warning(paste("The dataframe lacks expected columns:", paste(missing_cols, collapse = ", "), ". Plese keep the original structure as given on the template."))
}
if (length(extra_cols) > 0) {
warning(paste("The dataframe has additional columns:", paste(extra_cols, collapse = ", "), ". Plese keep the original structure as given on the template."))
}
if (length(missing_cols) == 0 && length(extra_cols) == 0) {
message(paste0("All column names in '", deparse(substitute(df)), "' are as expected."))
}
}
check_bulkUpload_colStr(bulk_data)
?check_arg_type
check_bulkUpload_argType <- function(df) {
if (!is.data.frame(df)) {
stop("The input must be a dataframe.")
}
# Define expected column types
expected_types <- c(
"Company Name" = c("character"),
"Site Name" = c("character", "integer"),
"Industry" = c("character"),
"Commodity (Optional)" = c("character"),
"Group (Optional)" = c("character"),
"Business Importance" = c("character"),
"Latitude" = c("numeric"),
"Longitude" = c("numeric"),
"Address" = c("character"),
# "...10" = c("NULL"),
"O4a" = c("numeric"),
"o25a5a" = c("numeric")
)
for (col in names(expected_types)) {
value <- df[[col]]
# Skip NULL or all-NA columns
if (is.null(value) || all(is.na(value))) {
next
}
actual_class <- class(value)[1]
if (!actual_class %in% expected_types[[col]]) {
warning(
paste0("Column '", col, "' has type '", actual_class,
"' but expected one of: ",
paste(expected_types[[col]], collapse = ", "), ".")
)
}
}
message("All non-empty fields contain expected data types.")
invisible(NULL)
}
check_bulkUpload_argType(bulk_data)
check_bulkUpload_missingData <- function(df) {
# Dataframe to store all violations
violations <- data.frame(
Row = integer(),
Site = character(),
Violation = character(),
stringsAsFactors = FALSE
)
for (i in seq_len(nrow(df))) {
comp     <- df$`Company Name`[i]
site     <- df$`Site Name`[i]
lat      <- df$Latitude[i]
lon      <- df$Longitude[i]
addr     <- df$Address[i]
bi       <- df$`Business Importance`[i]
o25a     <- df$O25a[i]
industry <- df$Industry[i]
# Helper to add violation to dataframe
add_violation <- function(msg) {
violations <<- rbind(
violations,
data.frame(Row = i, Site = site, Violation = msg, stringsAsFactors = FALSE)
)
warning(paste0("Row ", i, " (Site: ", site, "): ", msg))
}
# Violation 1: no location data provided
if (is.na(lat) & is.na(lon) & is.na(addr)) {
add_violation("Missing location data: neither coordinates nor address provided")
}
# Violation 2: no address provided, and incomplete coordinates (missing lat or long)
if ((!is.na(lat) & is.na(lon) & is.na(addr)) || (is.na(lat) & !is.na(lon) & is.na(addr))) {
add_violation("Location data incomplete: check Latitude/Longitude inputs")
}
# Violation 3: no business importance provided
if (is.na(bi) & is.na(o25a)) {
add_violation("Business Importance info missing: either categorical or numeric (O25a) must be provided")
}
# Violation 4: no Company Name provided
if (is.na(comp)) {
add_violation("Company Name is missing")
}
# Violation 5: no Site Name provided
if (is.na(site)) {
add_violation("Site Name is missing")
}
# Violation 6: no Industry provided
if (is.na(industry)) {
add_violation("Industry is missing")
}
}
# Summary table: count violations by type
summary_table <- aggregate(Row ~ Violation, data = violations, FUN = length)
names(summary_table)[2] <- "Count"
# Return both tables as a list
return(list(
violations_full = violations,
violations_summary = summary_table
))
}
check_bulkUpload_missingData(bulk_data)
View(bulk_data)
inputPath
inputPath <- "C:\\run_assessments_locally\\Aldi\\RFS_bulk_upload_sites_ALDI_mastersheet.xlsx"
## We use the data inserted into the Bulk Uploads Excel template provided to users.
bulk_data <- read_excel(inputPath, sheet = "Add your sites here")
check_bulkUpload_missingData(bulk_data)
inputPath <- "C:\\run_assessments_locally\\Aldi\\RFS_bulk_upload_sites_ALDI_mastersheet_v2.xlsx"
bulk_data <- read_excel(inputPath, sheet = "Add your sites here")
check_bulkUpload_missingData <- function(df) {
# Dataframe to store all violations
violations <- data.frame(
Row = integer(),
Site = character(),
Violation = character(),
stringsAsFactors = FALSE
)
for (i in seq_len(nrow(df))) {
comp     <- df$`Company Name`[i]
site     <- df$`Site Name`[i]
lat      <- df$Latitude[i]
lon      <- df$Longitude[i]
addr     <- df$Address[i]
bi       <- df$`Business Importance`[i]
o25a     <- df$O25a[i]
industry <- df$Industry[i]
# Helper to add violation to dataframe
add_violation <- function(msg) {
violations <<- rbind(
violations,
data.frame(Row = i, Site = site, Violation = msg, stringsAsFactors = FALSE)
)
warning(paste0("Row ", i, " (Site: ", site, "): ", msg))
}
# Violation 1: no location data provided
if (is.na(lat) & is.na(lon) & is.na(addr)) {
add_violation("Missing location data: neither coordinates nor address provided")
}
# Violation 2: no address provided, and incomplete coordinates (missing lat or long)
if ((!is.na(lat) & is.na(lon) & is.na(addr)) || (is.na(lat) & !is.na(lon) & is.na(addr))) {
add_violation("Location data incomplete: check Latitude/Longitude inputs")
}
# Violation 3: no business importance provided
if (is.na(bi) & is.na(o25a)) {
add_violation("Business Importance info missing: either categorical or numeric (O25a) must be provided")
}
# Violation 4: no Company Name provided
if (is.na(comp)) {
add_violation("Company Name is missing")
}
# Violation 5: no Site Name provided
if (is.na(site)) {
add_violation("Site Name is missing")
}
# Violation 6: no Industry provided
if (is.na(industry)) {
add_violation("Industry is missing")
}
}
# Summary table: count violations by type
summary_table <- aggregate(Row ~ Violation, data = violations, FUN = length)
names(summary_table)[2] <- "Count"
# Return both tables as a list
return(list(
violations_full = violations,
violations_summary = summary_table
))
message("Mandatory fields are provided for all entries.")
}
check_bulkUpload_missingData(bulk_data)
check_bulkUpload_missingData <- function(df) {
# Dataframe to store all violations
violations <- data.frame(
Row = integer(),
Site = character(),
Violation = character(),
stringsAsFactors = FALSE
)
for (i in seq_len(nrow(df))) {
comp     <- df$`Company Name`[i]
site     <- df$`Site Name`[i]
lat      <- df$Latitude[i]
lon      <- df$Longitude[i]
addr     <- df$Address[i]
bi       <- df$`Business Importance`[i]
o25a     <- df$O25a[i]
industry <- df$Industry[i]
# Helper to add violation to dataframe
add_violation <- function(msg) {
violations <<- rbind(
violations,
data.frame(Row = i, Site = site, Violation = msg, stringsAsFactors = FALSE)
)
warning(paste0("Row ", i, " (Site: ", site, "): ", msg))
}
# Violation 1: no location data provided
if (is.na(lat) & is.na(lon) & is.na(addr)) {
add_violation("Missing location data: neither coordinates nor address provided")
}
# Violation 2: no address provided, and incomplete coordinates (missing lat or long)
if ((!is.na(lat) & is.na(lon) & is.na(addr)) || (is.na(lat) & !is.na(lon) & is.na(addr))) {
add_violation("Location data incomplete: check Latitude/Longitude inputs")
}
# Violation 3: no business importance provided
if (is.na(bi) & is.na(o25a)) {
add_violation("Business Importance info missing: either categorical or numeric (O25a) must be provided")
}
# Violation 4: no Company Name provided
if (is.na(comp)) {
add_violation("Company Name is missing")
}
# Violation 5: no Site Name provided
if (is.na(site)) {
add_violation("Site Name is missing")
}
# Violation 6: no Industry provided
if (is.na(industry)) {
add_violation("Industry is missing")
}
}
if (nrow(violations) > 0) {
# Summary table: count violations by type
summary_table <- aggregate(Row ~ Violation, data = violations, FUN = length)
names(summary_table)[2] <- "Count"
# Return both tables as a list
return(list(
violations_full = violations,
violations_summary = summary_table
))
} else{
message("All entries are provided with mandatory data inputs.")
}
}
check_bulkUpload_missingData(bulk_data)
check_bulkUpload_biStr <- function(df) {
allowed_values <- c("Low", "Medium", "High", "Unknown")
# Loop through each row
for (i in seq_len(nrow(df))) {
site <- df$`Site Name`[i]
bi   <- df$`Business Importance`[i]
# Only check if not NA/empty
if (!is.na(bi) && trimws(bi) != "") {
if (!(bi %in% allowed_values)) {
warning(paste0(
"Row ", i, " (Site: ", site, "): Business Importance value '",
bi, "' is invalid. Allowed values: ", paste(allowed_values, collapse = ", ")
))
}
}
}
message("All entries for 'Business Importance' fulfill the expected structure.")
}
check_bulkUpload_biStr(bulk_data)
